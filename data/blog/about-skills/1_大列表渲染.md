---
title: 'å¤§åˆ—è¡¨æ¸²æŸ“'
date: Mon Oct 09 2023 23:37:25 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
lastmod: '2023-10-09'
tags: ['å¤§åˆ—è¡¨']
draft: false
summary: 'å¤§åˆ—è¡¨æ¸²æŸ“'
layout: PostSimple
bibliography: references-data.bib
canonicalUrl: https://dume.vercel.app/blog/about-skills/1_å¤§åˆ—è¡¨æ¸²æŸ“
---

ğŸ’¥ ğŸ”¥âŒâ—ï¸â“

## å¤§åˆ—è¡¨æ•°æ®æ¸²æŸ“

å½“ä¸€ä¸‹å­æ¸²æŸ“å¾ˆå¤šæ•°æ®æ—¶ï¼Œé¡µé¢ä¸Šæœ‰å¤§é‡ dom èŠ‚ç‚¹ä¼šå¾ˆå¡

1. for å¾ªç¯
2. å¯ä»¥åˆ©ç”¨å®šæ—¶å™¨ï¼Œåœ¨å¤šä¸ªå¾ªç¯é‡Œåˆ›å»º dom èŠ‚ç‚¹
3. åˆ©ç”¨ requestAnimationFrame åˆ›å»ºèŠ‚ç‚¹
4. åˆ©ç”¨è™šæ‹Ÿåˆ—è¡¨

ç¬¬ä¸€ä¸ªæœ€æ— è„‘ï¼Œç¬¬äºŒï¼Œç¬¬ä¸‰ä¾ç„¶ä¼šåˆ›å»ºå¾ˆå¤š dom èŠ‚ç‚¹ï¼Œéƒ½ä¸ç®—æ˜¯æœ€ä½³å®è·µ

### è™šæ‹Ÿåˆ—è¡¨

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <title>è™šæ‹Ÿåˆ—è¡¨</title>
    <style>
      .v-scroll {
        height: 600px;
        width: 400px;
        border: 3px solid #000;
        overflow: auto;
        position: relative;
        -webkit-overflow-scrolling: touch;
      }

      .infinite-list {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        z-index: -1;
      }

      .scroll-list {
        left: 0;
        right: 0;
        top: 0;
        position: absolute;
        text-align: center;
      }

      .scroll-item {
        padding: 10px;
        color: #555;
        box-sizing: border-box;
        border-bottom: 1px solid #999;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div ref="list" class="v-scroll" @scroll="scrollEvent($event)">
        <!-- æ¨¡æ‹ŸçœŸå®æ•°æ®ï¼Œæ’‘å¼€æ•´ä¸ªé«˜åº¦ -->
        <div class="infinite-list" :style="{ height: listHeight + 'px' }"></div>

        <div class="scroll-list" :style="{ transform: getTransform }">
          <div
            ref="items"
            class="scroll-item"
            v-for="item in visibleData"
            :key="item.id"
            :style="{ height: itemHeight + 'px',lineHeight: itemHeight + 'px' }"
          >
            {{ item.msg }}
          </div>
        </div>
      </div>
    </div>

    <script>
      var throttle = (func, delay) => {
        //èŠ‚æµ
        var prev = Date.now()
        return function () {
          var context = this
          var args = arguments
          var now = Date.now()
          if (now - prev >= delay) {
            func.apply(context, args)
            prev = Date.now()
          }
        }
      }

      let listData = []
      for (let i = 1; i <= 10000; i++) {
        listData.push({
          id: i,
          msg: i + ':' + Math.floor(Math.random() * 10000),
        })
      }

      const { createApp } = Vue
      createApp({
        data() {
          return {
            listData: listData,
            itemHeight: 60,
            //å¯è§†åŒºåŸŸé«˜åº¦
            screenHeight: 600,
            //åç§»é‡
            startOffset: 0,
            //èµ·å§‹ç´¢å¼•
            start: 0,
            //ç»“æŸç´¢å¼•
            end: null,
          }
        },
        computed: {
          //åˆ—è¡¨æ€»é«˜åº¦
          listHeight() {
            return this.listData.length * this.itemHeight
          },
          //å¯æ˜¾ç¤ºçš„åˆ—è¡¨é¡¹æ•°
          visibleCount() {
            // å¯è§†åŒºçš„é«˜åº¦ï¼ˆå¯ä»¥å†æ·»åŠ ä¸€å®šèŒƒå›´ï¼‰ é™¤ä»¥ æ¯ä¸ªå…ƒç´ çš„é«˜åº¦
            return Math.ceil(this.screenHeight / this.itemHeight)
          },
          //åç§»é‡å¯¹åº”çš„style
          getTransform() {
            return `translate3d(0,${this.startOffset}px,0)`
          },
          //è·å–çœŸå®æ˜¾ç¤ºåˆ—è¡¨æ•°æ®
          visibleData() {
            return this.listData.slice(this.start, Math.min(this.end, this.listData.length))
          },
        },
        mounted() {
          this.start = 0
          this.end = this.start + this.visibleCount
        },
        methods: {
          scrollEvent() {
            //å½“å‰æ»šåŠ¨ä½ç½®
            let scrollTop = this.$refs.list.scrollTop
            //æ­¤æ—¶çš„å¼€å§‹ç´¢å¼•
            // æ»šå‡ºå»çš„é«˜åº¦ï¼Œé™¤ä»¥ æ¯ä¸ªå…ƒç´ çš„é«˜åº¦ï¼Œå¾—åˆ°æ»šå‡ºå»çš„ä½ç½®
            this.start = Math.floor(scrollTop / this.itemHeight)
            //æ­¤æ—¶çš„ç»“æŸç´¢å¼•ï¼Œå¼€å§‹ç´¢å¼• + éœ€è¦æ¸²æŸ“çš„æ•°é‡
            this.end = this.start + this.visibleCount
            // æ­¤æ—¶çš„åç§»é‡
            // this.startOffset = scrollTop; æ³¨æ„
            this.startOffset = scrollTop - (scrollTop % this.itemHeight)
          },
        },
      }).mount('#app')
    </script>
  </body>
</html>
```

### scrollTop è§£æ

scrollTop å±æ€§æ˜¯**è·å–æˆ–è®¾ç½®ä¸€ä¸ªå…ƒç´ çš„å†…å®¹å‚ç›´æ»šåŠ¨çš„åƒç´ æ•°**ï¼Œå½“ä¸€ä¸ªå…ƒç´ çš„å†…å®¹æ²¡æœ‰äº§ç”Ÿå‚ç›´æ–¹å‘çš„æ»šåŠ¨æ¡ï¼Œé‚£ä¹ˆå®ƒçš„ scrollTop å€¼å°±ä¸º 0ã€‚

ä¸Šé¢çš„è™šæ‹Ÿåˆ—è¡¨ï¼Œref ä¸º list çš„å…ƒç´ æ˜¯çˆ¶ç›’å­ï¼Œä½†å†…éƒ¨çš„ infinite-list æ¨¡æ‹Ÿäº†çœŸå®åˆ—è¡¨çš„é«˜åº¦ï¼Œä»è€Œè®©å…ƒç´  list å†…éƒ¨äº§ç”Ÿæ»šåŠ¨æ¡ï¼Œ

è€Œé€šè¿‡ scroll äº‹ä»¶å°±å¯ä»¥è·å–åˆ°æ»šåŠ¨æ¡æ»šå‡ºå¯è§†åŒºåŸŸçš„é«˜åº¦ï¼Œè¿™ä¸ªé«˜åº¦å†ç»™çœŸå®çš„è™šæ‹Ÿåˆ—è¡¨ï¼Œå³å¯å®ç°å¤§åˆ—è¡¨æ¸²æŸ“ã€‚

### ä¸Šé¢è®¾ç½®çš„ startOffset è§£æ

ä¹‹æ‰€ä»¥æ˜¯ `this.startOffset = scrollTop - (scrollTop % this.itemHeight);` è€Œä¸æ˜¯ `this.startOffset = scrollTop;` å› ä¸ºé€šè¿‡ this.startï¼Œthis.end æˆªå–çš„æ•°ç»„è‚¯å®šéƒ½æ˜¯å®Œæ•´ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯å±éƒ½å±•ç¤ºå›ºå®šæ•°é‡çš„æ•°æ®ï¼Œå°±åƒæ¢é¡µä¼¼çš„ã€‚ã€‚ã€‚ä½†è¿™å¹¶ä¸æ˜¯çœŸå®çš„æ»šåŠ¨æ•ˆæœï¼ŒçœŸæ­£çš„æ»šåŠ¨æ•ˆæœè‚¯å®šæ˜¯é¡¶éƒ¨æˆ–è€…åº•éƒ¨çš„å•ä¸ªæ•°æ®æœ‰è¢«ç›–ä½ä¸€éƒ¨åˆ†çš„åœºæ™¯ã€‚

å¦‚ä½•äº§ç”Ÿç›–ä½ä¸€éƒ¨åˆ†çš„æ•ˆæœå‘¢ï¼Ÿ

æ— éå°±æ˜¯æ”¹å˜æœ‰æ•ˆçš„ scrollTop å€¼ï¼Œå› æ­¤å°±æ˜¯ `scrollTop - (scrollTop % this.itemHeight)`ï¼Œå–ä½™å¯ä»¥å¾—åˆ°å•ä¸ªæ•°æ®æ»šåŠ¨äº†å¤šå°‘

### æ¯é¡µæ¸²æŸ“ä¼˜åŒ–

ä¸Šé¢çš„ startã€end å°±æ˜¯å®Œæ•´çš„æ¯å±æ¸²æŸ“çš„ä¸ªæ•°ï¼Œä½†å…¶å®å¦‚æœå¿«é€Ÿæ»šåŠ¨ï¼Œåº•éƒ¨çš„å…ƒç´ ä¼šæœ‰é—ªç°çš„æ•ˆæœï¼Œå› æ­¤å¯ä»¥åœ¨æ¯å±å›ºå®šæ•°é‡çš„åŸºç¡€ä¸Šå†åŠ ä¸Šå‡ ä¸ªã€‚

å³ï¼š` this.end = this.start + this.visibleCount + 5` ç±»ä¼¼è¿™æ ·çš„

## åŠ¨æ€æ•°æ®å‘¢ï¼Ÿ

ç°åœ¨æ˜¯å†™æ­»çš„æ•°æ®ï¼Œé‚£å¦‚æœæ˜¯åŠ¨æ€åŠ è½½çš„æ•°æ®å‘¢

- ä¸èƒ½ä¸€ç›´æ»šåŠ¨ï¼Œéœ€è¦ loading çŠ¶æ€

## ä¸Šæ‹‰åŠ è½½

- æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæˆ–ç•™ç‚¹ä½™é‡ï¼‰ï¼Œå°±å»å‘é€è¯·æ±‚
- åˆ¤æ–­æ¡ä»¶ï¼šscrollTopï¼ˆæ»šåŠ¨é«˜åº¦ï¼‰ + windowHeightï¼ˆå±å¹•æœ‰æ•ˆé«˜åº¦ï¼‰ = scrollHeightï¼ˆå†…å®¹é«˜åº¦ï¼‰

```html
<div id="content">
  <!-- æ­¤å¤„ä¸ºåŠ è½½çš„å†…å®¹ -->
</div>

<div id="loading"></div>

<script>
  const content = document.getElementById('content')
  const loading = document.getElementById('loading')
  let isLoading = false

  window.addEventListener('scroll', () => {
    // æ­£åœ¨åŠ è½½ä¸­ï¼Œç›´æ¥è¿”å›
    if (isLoading) return

    // è·å–ç›¸åº”çš„é«˜åº¦ï¼Œåšåˆ¤æ–­
    let scrollTop = document.documentElement.scrollTop || document.body.scrollTop
    let windowHeight = window.innerHeight || document.documentElement.clientHeight
    let documentHeight = document.documentElement.scrollHeight || document.body.scrollHeight

    // åˆ¤æ–­æ˜¯å¦æ¥è¿‘é¡µé¢åº•éƒ¨ï¼ˆè¿™é‡Œè®¾å®šè·ç¦»åº•éƒ¨ 100px è§¦å‘åŠ è½½ï¼‰
    if (scrollTop + windowHeight >= documentHeight - 100) {
      // æ˜¾ç¤ºåŠ è½½æç¤º
      loading.style.display = 'block'
      isLoading = true

      // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½æ•°æ®ï¼ˆè¿™é‡Œä½¿ç”¨ setTimeout æ¨¡æ‹Ÿï¼‰
      setTimeout(function () {
        // æ¨¡æ‹ŸåŠ è½½å®Œæˆåçš„å›è°ƒ
        var newData = 'åŠ è½½çš„å†…å®¹' // è¿™é‡Œæ›¿æ¢ä¸ºä½ å®é™…çš„åŠ è½½æ•°æ®

        // æ·»åŠ åŠ è½½çš„å†…å®¹åˆ°é¡µé¢
        content.innerHTML += newData

        // éšè—åŠ è½½æç¤º
        loading.style.display = 'none'
        isLoading = false
      }, 1000) // è¿™é‡Œçš„ 1000 è¡¨ç¤ºæ¨¡æ‹ŸåŠ è½½çš„å»¶è¿Ÿæ—¶é—´
    }
  })
</script>
```

å¦‚æœè€ƒè™‘åˆ°å¤§åˆ—è¡¨ï¼Œè¿˜ä¸èƒ½ç›´æ¥å°†å†…å®¹æ·»åŠ è‡³é¡µé¢ï¼Œè€Œæ˜¯å­˜èµ·æ¥ï¼Œç„¶ååŠ¨æ€æˆªå–

å¦å¤–ä¸Šé¢ç›‘å¬çš„ scroll äº‹ä»¶æ˜¯ä½œç”¨åœ¨ window ä¸Šçš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½œç”¨åœ¨ å…ƒç´ ä¸Šï¼Œå¦‚ä¸‹

## ä¸‹æ‹‰åˆ·æ–°

ä¸‹æ‹‰åˆ·æ–°ï¼Œç³»ç»Ÿå¹¶æ²¡æœ‰æä¾›ç°æˆçš„ç±»ä¼¼ scroll çš„äº‹ä»¶ï¼Œå› æ­¤åªèƒ½é€šè¿‡ touch äº‹ä»¶æ¨¡æ‹Ÿ

```html
<div id="content">
  <!-- æ­¤å¤„ä¸ºæ˜¾ç¤ºçš„å†…å®¹ -->
</div>

<script>
  var content = document.getElementById('content')
  var startY
  var isRefreshing = false

  // ç›‘å¬è§¦æ‘¸äº‹ä»¶ ğŸ”¥
  content.addEventListener('touchstart', function (e) {
    // å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œåˆ™ç›´æ¥è¿”å›
    if (isRefreshing) return

    // è®°å½•è§¦æ‘¸èµ·å§‹ä½ç½®
    startY = e.touches[0].clientY
  })

  // ç›‘å¬è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
  content.addEventListener('touchmove', function (e) {
    // å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œåˆ™ç›´æ¥è¿”å›
    if (isRefreshing) return

    // è·å–å½“å‰è§¦æ‘¸ä½ç½®
    var currentY = e.touches[0].clientY
    var distance = currentY - startY

    // å¦‚æœä¸‹æ‹‰è·ç¦»å¤§äºç­‰äº 100pxï¼Œåˆ™è§¦å‘ä¸‹æ‹‰åˆ·æ–° ğŸ”¥
    if (distance >= 100) {
      // æ˜¾ç¤ºåˆ·æ–°æç¤º
      content.innerHTML = 'åˆ·æ–°ä¸­...'

      // æ¨¡æ‹Ÿå¼‚æ­¥åˆ·æ–°æ•°æ®ï¼ˆè¿™é‡Œä½¿ç”¨ setTimeout æ¨¡æ‹Ÿï¼‰
      setTimeout(function () {
        // æ¨¡æ‹Ÿåˆ·æ–°å®Œæˆåçš„å›è°ƒ
        var refreshedData = 'åˆ·æ–°çš„å†…å®¹' // è¿™é‡Œæ›¿æ¢ä¸ºä½ å®é™…çš„åˆ·æ–°æ•°æ®

        // æ›´æ–°å†…å®¹
        content.innerHTML = refreshedData

        // é‡ç½®åˆ·æ–°çŠ¶æ€
        isRefreshing = false
      }, 1000) // è¿™é‡Œçš„ 1000 è¡¨ç¤ºæ¨¡æ‹Ÿåˆ·æ–°çš„å»¶è¿Ÿæ—¶é—´
    }
  })

  // ç›‘å¬è§¦æ‘¸ç»“æŸäº‹ä»¶
  content.addEventListener('touchend', function () {
    // é‡ç½®èµ·å§‹ä½ç½®
    startY = null
  })
</script>
```

**æ€»ç»“**ï¼šå…¶å®å°±æ˜¯åˆ©ç”¨ touch äº‹ä»¶ï¼Œçœ‹ touchmove äº†å¤šå°‘ï¼Œè¶…è¿‡äº†é˜ˆå€¼ï¼Œå°±è§¦å‘æ¥å£æ›´æ–°

## å¤§åˆ—è¡¨æ¸²æŸ“

å¦‚æœæ¶‰åŠåˆ°å…ƒç´ åŠ¨æ€å˜åŒ–çš„ï¼Œåˆ™éœ€è¦åŠ¨æ€çš„è®¡ç®—ï¼Œç›‘å¬æ¯ä¸€é¡¹çš„é«˜åº¦å˜åŒ–ï¼Œç„¶ååœ¨éå†æ•°ç»„ï¼Œé‡æ–°è®¡ç®—å‰©ä½™é¡¹çš„é«˜åº¦ã€‚

[æ›´å¤šå‚è€ƒ](https://zhuanlan.zhihu.com/p/444778554)

```js
// app.jsx
import "./styles.css";
import VList from "./components/vlist";
import ObserverItem from "./components/observer-item";
import faker from "faker";

let data = [];
for (let id = 0; id < 100; id++) {
  const item = {
    id,
    value: faker.lorem.paragraphs() // é•¿æ–‡æœ¬
  };

  if (id % 10 === 1) {
    item.src = faker.image.image();
  }
  data.push(item);
}

export default function App() {
  return (
    <div className="App">
      <VList list={data}>
        {({ index, item, measure }) => (
          <ObserverItem
            index={index}
            key={item.id}
            item={item}
            measure={measure}
          >
            <>
              {item.value}
              {item.src && <img src={item.src} alt="" />}
            </>
          </ObserverItem>
        )}
      </VList>
    </div>
  );
}

// VList.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";

export default function Vlist(props) {
  const { list = [] } = props;
  const viewport = useRef(null); // å¯è§†åŒºåŸŸ
  const listArea = useRef(null); // æ¸²æŸ“åŒºåŸŸ
  const phantom = useRef(null); // å ä½åŒºåŸŸï¼Œåˆ—è¡¨æ€»é«˜åº¦

  // é¢„ä¼°é«˜åº¦
  const defaultItemSize = 100;
  // è®°å½•åˆ—è¡¨é¡¹çš„ä½ç½®ä¿¡æ¯
  const [positions, setpositions] = useState(
    list.map((item, index) => {
      return {
        index,
        height: defaultItemSize,
        top: index * defaultItemSize,
        bottom: (index + 1) * defaultItemSize
      };
    })
  );
  window.positions = positions;

  // åˆ—è¡¨æ€»é«˜åº¦
  const [phantomHeight, setphantomHeight] = useState(
    positions.reduce((total, item) => total + item.height, 0)
  );

  const viewCount = 10; // æ¸²æŸ“æ•°é‡
  const [startIndex, setstartIndex] = useState(0); // å¼€å§‹index
  // ç»“æŸindex
  const endIndex = useMemo(() => startIndex + viewCount, [startIndex]);
  const [startOffset, setstartOffset] = useState(0); // åç§»é‡

  useEffect(() => {
    if (positions?.length) {
      const totalHeight = positions.reduce(
        (total, item) => total + item.height,
        0
      );
      setphantomHeight(totalHeight);
    }
  }, [positions]);

  // æµ‹é‡é«˜åº¦
  const measure = (index, height) => {
    // å¦‚æœæ²¡æœ‰ä¼ å…¥heightï¼Œä¸»åŠ¨è¿›è¡Œæµ‹é‡
    if (height === undefined) {
      height =
        listArea.current.querySelector(`[index="${index}"]`)?.clientHeight ||
        defaultItemSize;
    }

    positions.forEach((item) => {
      if (item.index === index) {
        let oldHeight = item.height;
        let dHeight = oldHeight - height;

        // å‘ä¸‹æ›´æ–°
        if (dHeight) {
          item.height = height;
          item.bottom = item.bottom - dHeight;

          for (let k = index + 1; k < positions.length; k++) {
            positions[k].top = positions[k - 1].bottom;
            positions[k].bottom = positions[k].bottom - dHeight;
          }
        }
      }
    });
    setpositions(positions);
  };

  // è·å–startIndex äºŒåˆ†æŸ¥æ‰¾æ³•
  const getStartIndex = (scrollTop) => {
    let item = positions.find((i) => i && i.bottom > scrollTop);
    return item.index;
  };

  // è·å–startOffset
  const getStartOffset = (startIndex) => {
    return startIndex >= 1 ? positions[startIndex - 1].bottom : 0;
  };

  /**
   * è·å–æ»šåŠ¨è·ç¦» scrollTop
   * æ ¹æ® scrollTop å’Œ itemSize è®¡ç®—å‡º startIndex å’Œ endIndex
   * æ ¹æ® scrollTop å’Œ itemSize è®¡ç®—å‡º startOffset
   * æ˜¾ç¤ºstartIndex å’Œ endIndexä¹‹é—´çš„å…ƒç´ 
   * è®¾ç½®listAreaçš„åç§»é‡ä¸ºstartOffset
   */
  const onScroll = () => {
    const scrollTop = viewport.current.scrollTop; // æ»šåŠ¨è·ç¦»
    const startIndex = getStartIndex(scrollTop);
    setstartIndex(startIndex);

    const startOffset = getStartOffset(startIndex);
    setstartOffset(startOffset);
  };

  return (
    <div className="viewport" ref={viewport} onScroll={onScroll}>
      <div
        className="list-phantom"
        ref={phantom}
        style={{ height: `${phantomHeight}px` }}
      ></div>
      <div
        className="list-area"
        ref={listArea}
        style={{ transform: `translate3d(0,${startOffset}px,0)` }}
      >
        {list.map(
          (item, index) =>
            index >= startIndex &&
            index <= endIndex &&
            props.children({
              index,
              item,
              measure
            })
        )}
      </div>
    </div>
  );
}


// åŠ¨æ€ç›‘å¬é«˜åº¦
import React, { useEffect, useRef } from "react";

export default function Item(props) {
  const { index, measure } = props;
  const element = useRef(null);

  useEffect(() => {
    measureItem(index);

    return observe();
  }, []);

  // ç›‘å¬é«˜åº¦å˜åŒ–
  const observe = () => {
    const resizeObserver = new ResizeObserver(() => {
      // è·å–å½“å‰åˆ—è¡¨é¡¹çš„é«˜åº¦
      const el = element.current;
      if (el && el.offsetHeight) {
        // è§¦å‘æ›´æ–°
        measure(index, el.offsetHeight);
      }
    });
    resizeObserver.observe(element.current);

    return () => resizeObserver.disconnect();
  };

  // åˆæ¬¡æ¸²æŸ“å®Œæˆ
  const measureItem = (index) => {
    const item = element.current;
    if (item?.clientHeight) {
      measure(index, item.clientHeight);
    }
  };

  return (
    <div index={index} className="list-item" ref={element}>
      {props.children}
    </div>
  );
}

```
